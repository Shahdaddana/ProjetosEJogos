<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerador de Gráfico Likert</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; text-align: center; }
    .container { max-width: 900px; margin: auto; padding: 30px; }
    h2 { margin-bottom: 20px; }
    p { margin-bottom: 10px; }
    textarea { width: 11%; height: 200px; font-family: monospace; margin-top: 10px; font-size:x-large;}
    button { margin: 20px 0; padding: 12px 25px; font-size: 16px; cursor: pointer; border-radius: 8px; border: none; background: #4CAF50; color: white; }
    button:hover { background: #45a049; }
    #chart { width: 100%; max-width: 1000px; height: 700px; margin: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Gerador de Gráfico de Escala Likert</h2>
    <p>Digite ou cole os dados (cada linha = uma questão, colunas separadas por vírgula ou espaço, no formato:<br>
      <b>Discordo totalmente, Discordo, Neutro, Concordo, Concordo totalmente</b>):</p>
    <textarea id="inputData">
1,0,2,3,3
0,0,0,2,7
0,1,1,3,4
2,1,1,4,1
    </textarea>
    <br>
    <button onclick="gerarGrafico()">Gerar Gráfico</button>
  </div>

  <div id="chart"></div>

  <script>
    function calcularMediana(freqs) {
      const expanded = [];
      freqs.forEach((count, i) => {
        for (let j = 0; j < count; j++) expanded.push(i+1);
      });
      expanded.sort((a,b) => a-b);

      if (expanded.length === 0) return null;
      const mid = Math.floor(expanded.length / 2);
      if (expanded.length % 2 === 0) {
        return (expanded[mid - 1] + expanded[mid]) / 2;
      } else {
        return expanded[mid];
      }
    }

    function gerarGrafico() {
      const raw = document.getElementById("inputData").value.trim();
      const rows = raw
        .split("\n")
        .map(r => r.trim().split(/[\s,]+/).map(Number))
        .filter(r => r.length >= 5 && r.every(x => !isNaN(x)));

      // --- Ordenar pelo lado direito ---
      const rightSums = rows.map(r => r[2]/2 + r[3] + r[4]); // metade do neutro + Concordo + Concordo totalmente
      const sortedIndices = rightSums
        .map((sum, i) => ({ sum, i }))
        .sort((a, b) => b.sum - a.sum)
        .map(obj => obj.i);

      const sortedRows = sortedIndices.map(i => rows[i]);
      const labels = sortedIndices.map(i => "Q" + (i + 1));

      // Normalizar para porcentagem
      const percRows = sortedRows.map(row => {
        const total = row.reduce((a, b) => a + b, 0);
        return row.map(v => (total > 0 ? (v / total * 100) : 0));
      });

      const traces = [];
      const cores = ["#e63636","#e66c37","#cccccc","#8fbc8f","#008000"];
      const nomes = ["Discordo totalmente","Discordo","Neutro","Concordo","Concordo totalmente"];

      percRows.forEach((row, i) => {
        let [dt, d, n, c, ct] = row;

        // --- calcular base para centralizar no Neutro ---
        const baseN = -n/2;
        const baseD = baseN - d;
        const baseDT = baseD - dt;
        const baseC = n/2;
        const baseCT = baseC + c;

        // Discordo totalmente
        traces.push({
          x: [dt], y: [labels[i]],
          base: baseDT,
          type: "bar", orientation: "h",
          marker: { color: cores[0] },
          name: nomes[0],
          text: [dt.toFixed(0) + "%"], textposition: "inside", insidetextanchor: "middle",
          showlegend: i === 0
        });

        // Discordo
        traces.push({
          x: [d], y: [labels[i]],
          base: baseD,
          type: "bar", orientation: "h",
          marker: { color: cores[1] },
          name: nomes[1],
          text: [d.toFixed(0) + "%"], textposition: "inside", insidetextanchor: "middle",
          showlegend: i === 0
        });

        // Neutro
        traces.push({
          x: [n], y: [labels[i]],
          base: baseN,
          type: "bar", orientation: "h",
          marker: { color: cores[2] },
          name: nomes[2],
          text: [n.toFixed(0) + "%"], textposition: "inside", insidetextanchor: "middle",
          showlegend: i === 0
        });

        // Concordo
        traces.push({
          x: [c], y: [labels[i]],
          base: baseC,
          type: "bar", orientation: "h",
          marker: { color: cores[3] },
          name: nomes[3],
          text: [c.toFixed(0) + "%"], textposition: "inside", insidetextanchor: "middle",
          showlegend: i === 0
        });

        // Concordo totalmente
        traces.push({
          x: [ct], y: [labels[i]],
          base: baseCT,
          type: "bar", orientation: "h",
          marker: { color: cores[4] },
          name: nomes[4],
          text: [ct.toFixed(0) + "%"], textposition: "inside", insidetextanchor: "middle",
          showlegend: i === 0
        });
      });

      const medianas = sortedRows.map(calcularMediana);

      const layout = {
        barmode: "stack",
        title: "Resultados da Escala Likert (em %)",
        xaxis: {
          zeroline: true,
          zerolinewidth: 2,
          zerolinecolor: "black",
          title: "Percentual de respostas",
          ticksuffix: "%"
        },
        yaxis: { autorange: "reversed" },
        legend: { orientation: "h", y: -0.2 },
        // annotations: medianas.map((m, i) => ({
        //   x: 0,
        //   y: labels[i],
        //   text: "μ₁/₂: " + (m !== null ? m : "–"),
        //   showarrow: false,
        //   font: { size: 14, color: "black" },
        //   align: "left",
        //   xanchor: "left",
        //   xshift: -250
        // }))
      };

      Plotly.newPlot("chart", traces, layout);
    }

    gerarGrafico();
  </script>
</body>
</html>
