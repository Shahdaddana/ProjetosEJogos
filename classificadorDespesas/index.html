<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Gráficos Financeiros</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
    }
    h2 { text-align: center; margin-top: 0; }
    .toggle-group { margin: 20px 0; }
    .toggle-label { margin-bottom: 8px; font-size: 16px; }
    .toggle {
      display: flex;
      border: 2px solid #0088cc;
      border-radius: 10px;
      overflow: hidden;
    }
    .toggle button {
      flex: 1;
      padding: 12px 0;
      border: none;
      background: transparent;
      font-size: 16px;
      cursor: pointer;
      color: var(--tg-theme-text-color);
    }
    .toggle button.active {
      background: #0088cc;
      color: white;
      font-weight: bold;
    }
    label { display:block; margin-top:8px; }
    input[type="date"] {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #aaa;
      font-size: 16px;
      margin-bottom: 8px;
    }
    .hint { font-size:14px; color: #888; margin-top:8px; text-align:center; }
  </style>
</head>
<body>

  <h2>Gráficos Financeiros</h2>

  <div class="toggle-group">
    <div class="toggle-label">Tipo</div>
    <div class="toggle" id="toggleTipo">
      <button data-value="pessoal" class="active">Pessoal</button>
      <button data-value="empresa">Empresa</button>
    </div>
  </div>

  <div class="toggle-group">
    <div class="toggle-label">Movimento</div>
    <div class="toggle" id="toggleMovimento">
      <button data-value="receita" class="active">Receita</button>
      <button data-value="despesa">Despesa</button>
    </div>
  </div>

  <label>Data Início</label>
  <input type="date" id="dataInicio">

  <label>Data Fim</label>
  <input type="date" id="dataFim">

  <div class="hint" id="status">Preencha os campos e use o botão do Telegram para enviar.</div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram?.WebApp;
    if (!tg) {
      document.body.innerHTML = '<h2>Abra este app pelo Telegram</h2>';
      throw new Error('Telegram WebApp API não encontrada');
    }

    tg.expand();

    function setupToggle(id) {
      const el = document.getElementById(id);
      const buttons = el.querySelectorAll("button");
      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          buttons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
        });
      });
    }

    setupToggle("toggleTipo");
    setupToggle("toggleMovimento");

    const statusEl = document.getElementById('status');
    function setStatus(text) { statusEl.textContent = text; }

    function validate() {
      const start = document.getElementById('dataInicio').value;
      const end = document.getElementById('dataFim').value;
      if (!start || !end) {
        setStatus('Preencha Data Início e Data Fim.');
        return false;
      }
      if (start > end) {
        setStatus('Data Início não pode ser maior que Data Fim.');
        return false;
      }
      return true;
    }

    tg.MainButton.setText('Enviar');
    tg.MainButton.show();

    tg.MainButton.onClick(() => {
      if (!validate()) return;
      tg.MainButton.setText('Enviando...');
      tg.MainButton.disable();

      const tipo = document.querySelector("#toggleTipo .active").dataset.value;
      const movimento = document.querySelector("#toggleMovimento .active").dataset.value;
      const payload = {
        tipo,
        movimento,
        data_inicio: document.getElementById("dataInicio").value,
        data_fim: document.getElementById("dataFim").value,
        user: tg.initDataUnsafe?.user ?? null
      };

      tg.sendData(JSON.stringify(payload));
      setStatus('Enviado. Fechando...');
      setTimeout(() => tg.close(), 700);
    });

    window.addEventListener('unload', () => {
      try { tg.MainButton.hide(); } catch (e) {}
    });
  </script>

</body>
</html>
